FROM php:7.3-fpm

WORKDIR /var/www

##########################################################################
#
# WARNING: This file was generated by update.php. Do not edit it directly.
#
#

ENV COMPOSER_ALLOW_SUPERUSER 1
ENV COMPOSER_HOME /tmp

# Update the user/group in "php-fpm.conf" and "entrypoint-php.sh"
# if PHP_FPM_USER or PHP_FPM_GROUP is changed
ENV PHP_FPM_USER wp_php
ENV PHP_FPM_GROUP wp_php
ENV PHP_FPM_UID 1000
ENV PHP_FPM_GID 1000

# install the PHP extensions we need
RUN set -ex; \
	\
	apt-get update; \
	\
	apt-get install -y --no-install-recommends libjpeg-dev libpng-dev libzip-dev libmemcached-dev unzip libmagickwand-dev ghostscript libonig-dev locales; \
	sed -i 's/^# *\(\(ru_RU\|fr_FR\|de_DE\|es_ES\|ja_JP\).UTF-8\)/\1/' /etc/locale.gen; \
	locale-gen; \
	\
	docker-php-ext-configure gd --with-png-dir=/usr --with-jpeg-dir=/usr; \
	\
	docker-php-ext-install gd opcache mysqli zip exif intl mbstring; \
	\
	pecl install xdebug-2.7.2; \
	pecl install memcached-3.1.3; \
	pecl install imagick; \
	docker-php-ext-enable imagick; \
	\
	curl --silent --fail --location --retry 3 --output /tmp/installer.php --url https://getcomposer.org/installer; \
	curl --silent --fail --location --retry 3 --output /tmp/installer.sig --url https://composer.github.io/installer.sig; \
	php -r " \
		\$signature = file_get_contents( '/tmp/installer.sig' ); \
		\$hash = hash( 'sha384', file_get_contents('/tmp/installer.php') ); \
		if ( \$signature !== \$hash ) { \
			unlink( '/tmp/installer.php' ); \
			unlink( '/tmp/installer.sig' ); \
			echo 'Integrity check failed, installer is either corrupt or worse.' . PHP_EOL; \
			exit( 1 ); \
		}"; \
	php /tmp/installer.php --no-ansi --install-dir=/usr/bin --filename=composer; \
	composer --ansi --version --no-interaction; \
	rm -f /tmp/installer.php /tmp/installer.sig;

COPY entrypoint.sh /entrypoint.sh
COPY docker-entrypoint.d /docker-entrypoint.d
COPY php-fpm.conf /usr/local/etc/php-fpm.d/zz-wordpress.conf

RUN chmod +x /entrypoint.sh && \
    chmod +x /docker-entrypoint.d/*.sh && \
    groupadd -g ${PHP_FPM_GID} -r ${PHP_FPM_GROUP} && \
    useradd -M -u ${PHP_FPM_UID} -s /bin/bash -g ${PHP_FPM_GROUP} ${PHP_FPM_USER}

ENTRYPOINT [ "/entrypoint.sh" ]

CMD [ "php-fpm" ]
