FROM devilbox/php-fpm-5.2:latest

WORKDIR /var/www

##########################################################################
#
# WARNING: This file was generated by update.php.
#
# You can find the relevant template in the `/templates` folder.
#

ENV COMPOSER_ALLOW_SUPERUSER 1
ENV COMPOSER_HOME /tmp

# install the PHP extensions we need
RUN set -ex; \
	\
	apt-get update; \
	\
	apt-get install -y --no-install-recommends sudo rsync; \
	apt-get upgrade openssl -y; \
	update-ca-certificates --fresh; \
	\
	pecl install zendopcache-7.0.5; \
	pecl install xdebug-2.2.7;

COPY entrypoint.sh /entrypoint.sh
COPY common.sh /common.sh
COPY php-fpm.conf /usr/local/etc/php-fpm.d/zz-wordpress.conf

ARG imagemagic_config=/etc/ImageMagick-6/policy.xml
RUN if [ -f $imagemagic_config ] ; then \
		sed -i 's/<policy domain="coder" rights="none" pattern="PDF" \/>/<policy domain="coder" rights="read|write" pattern="PDF" \/>/g' $imagemagic_config; \
	else \
		echo did not see file $imagemagic_config; \
	fi

RUN chmod +x /entrypoint.sh && \
    chmod +x /common.sh && \
    groupadd -g 1000 -r wp_php && \
    useradd -u 1000 -s /bin/bash -g wp_php wp_php

ENTRYPOINT [ "/entrypoint.sh" ]

CMD [ "php-fpm" ]
