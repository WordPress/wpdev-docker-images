FROM devilbox/php-fpm-8.0:latest

WORKDIR /var/www

##########################################################################
#
# WARNING: This file was generated by update.php.
#
# You can find the relevant template in the `/templates` folder.
#

ENV COMPOSER_ALLOW_SUPERUSER 1
ENV COMPOSER_HOME /tmp

# install the PHP extensions we need
RUN set -ex; \
	\
	apt-get update; \
	\
	apt-get install -y --no-install-recommends unzip sudo rsync git; \
	\
	docker-php-ext-install mysqli; \
	\
	curl --silent --fail --location --retry 3 --output /tmp/installer.php --url https://getcomposer.org/installer; \
	curl --silent --fail --location --retry 3 --output /tmp/installer.sig --url https://composer.github.io/installer.sig; \
	php -r " \
		\$signature = file_get_contents( '/tmp/installer.sig' ); \
		\$hash = hash( 'sha384', file_get_contents('/tmp/installer.php') ); \
		if ( \$signature !== \$hash ) { \
			unlink( '/tmp/installer.php' ); \
			unlink( '/tmp/installer.sig' ); \
			echo 'Integrity check failed, installer is either corrupt or worse.' . PHP_EOL; \
			exit( 1 ); \
		}"; \
	php /tmp/installer.php --no-ansi --install-dir=/usr/bin --filename=composer; \
	composer --ansi --version --no-interaction; \
	rm -f /tmp/installer.php /tmp/installer.sig;

COPY entrypoint.sh /entrypoint.sh
COPY common.sh /common.sh
COPY php-fpm.conf /usr/local/etc/php-fpm.d/zz-wordpress.conf

RUN chmod +x /entrypoint.sh && \
    chmod +x /common.sh && \
    groupadd -g 1000 -r wp_php && \
    useradd -u 1000 -s /bin/bash -g wp_php wp_php

ENTRYPOINT [ "/entrypoint.sh" ]

CMD [ "php-fpm" ]
